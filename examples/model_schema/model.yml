domain:
    cls: SedimentDBLDomain
    init_params:
        cell_size: !unit 100 mum
        sediment_length: !unit 10 mm
        dbl_length: !unit 1 mm
        porosity: 0.6


environment:

    oxy:
        cls: Variable
        init_params:
            name: oxy
            create:
                hasOld: true
                value: !unit 0.0 mol/l

            constraints:
                top: !unit 0.2e-3 mol/l
                bottom: !unit 0 mol/l

    h2s:
        cls: Variable
        init_params:
            name: h2s
            create:
                hasOld: true
                value: !unit 0.0 mol/l

            constraints:
                top: !unit 0.0 mol/l
                bottom: !unit 1e-3 mol/l


    irradiance:
        cls: Irradiance
        init_params:
            hours_total: 24
            day_fraction: 0.3

            channels:
                - name: par
                  k0: !unit 15.3 1/cm
#                  k_mods:
#                    - [cyano, 6523]
#                    - [cyano, 65253]
#                    - [cyano, !unit 125 g/mm**3]


    abiotic_h2s_oxidation:
        cls: ExprProcess
        init_params:
            formula: porosity * k * oxy**2 * h2s
            varnames: ['oxy', 'h2s', 'porosity']
            params:
                k: !unit '70 1/((10**-3)*mol/l)**2/h'

    aerobic_respiration:
        cls: ExprProcess
        init_params:
            formula: Vmax
            varnames: []
            params:
                Vmax: !unit 1e-3 mol/l/h
            responses:
                saturate(oxy):
                    cls: ExprProcess
                    init_params:
                        formula: saturation_response(oxy, Km)
                        varnames:
                            - oxy
                        params:
                            Km: !unit 1e-5 mol/l


microbes:
    cyano:
        init_params:
            name: cyano
            features:
                biomass:
                    init_params:
                        name: biomass
                        create:
                            value: !unit 1e-20 g/cm**3

                chla:
                    init_params:
                        name: chla
                        create:
                            value: !unit 0.0 g/cm**3

            processes:
                oxyPS:
                    init_params:
                        formula: Qmax * biomass
                        varnames:
                            - biomass
                        params:
                            Qmax: !unit "0.00841 mol/g/h"

                        responses:
                            optimum(par):
                                cls: ExprProcess
                                init_params:
                                    formula: optimum_response(par, Ks, Ki)
                                    varnames:
                                        - par
                                    params:
                                        Ks: 1
                                        Ki: 10

                            inhibit(oxy):
                                cls: ExprProcess
                                init_params:
                                    formula: inhibition_response(oxy, Kmax, Khalf)
                                    varnames:
                                        - oxy
                                    params:
                                        Kmax: !unit "0.8e-3 mol/l"
                                        Khalf: !unit "0.7e-3 mol/l"

                            inhibit(h2s):
                                init_params:
                                    formula: inhibition_response(h2s, Kmax, Khalf)
                                    varnames:
                                        - h2s
                                    params:
                                        Kmax: !unit "0.35e-3 mol/l"
                                        Khalf: !unit "0.3e-3 mol/l"

                respire:
                    init_params:
                        formula: Qmax * biomass
                        varnames:
                            - biomass
                        params:
                            Qmax: !unit 0.000199e-6 mol/g/h

                        responses:
                            saturate(oxy):
                                init_params:
                                    formula: saturation_response(oxy, Km)
                                    varnames:
                                        - oxy
                                    params:
                                        Km: !unit 1e-6 mol/l

                chla_synth:
                    init_params:
                        formula: G * biomass
                        varnames: [biomass]
                        params:
                            G: !unit 0.002 1/h

                        responses:
                            synthesis(chla, biomass, oxy):
                                init_params:
                                    formula: (oxy < oxy_thresh) & (chla/biomass < chla_max)
                                    varnames:
                                        - chla
                                        - biomass
                                        - oxy
                                    params:
                                        oxy_thresh: !unit 1e-9 mol/l
                                        chla_max:  0.003

    csdb:
        init_params:
            name: csb
            features:
                biomass:
                    init_params:
                        name: biomass
                        create:
                            value: !unit 0.0 g/cm**3

            processes:
                sulfoxid:
                    init_params:
                        formula: biomass * Qmax
                        varnames:
                            - biomass
                        params:
                            Qmax: !unit 0.3233 mol/g/h

                        responses:
                            saturate(oxy):
                                init_params:
                                    formula: saturation_response(oxy, Km)
                                    varnames:
                                        - oxy
                                    params:
                                        Km: !unit 1e-6 mol/l

                            saturate(h2s):
                                init_params:
                                    formula: saturation_response(h2s, Km)
                                    varnames:
                                        - h2s
                                    params:
                                        Km: !unit 0.7e-6 mol/l


formulae:
    optimum_response:
        variables: [x, Ks, Ki]
        expr: x/(x + Ks)/(1 + x/Ki)


    inhibition_response:
        variables: [x, Kmax, Khalf]
        expr: (Kmax - x) / (2*Kmax - Khalf - x) * (x < Kmax)

    saturation_response:
        variables: [x, Km]
        expr: x / (Km + x)

equations:
    oxyEqn:
        var:
            name: oxy
            store: domain

        transient:
            coeff: 1

        diffusion:
            coeff:
                cls: ExprProcess
                init_params:
                    formula: porosity * D0_oxy
                    varnames:
                        - porosity
                    params:
                        D0_oxy: !unit 0.05 cm**2/h

        sources:
            - name: abiotic_h2s_oxidation
              coeff: -2
              store: env

            - name: aerobic_respiration
              coeff: -1
              store: env

            - name: oxyPS
              coeff: 1
              store: microbes.cyano.processes

            - name: respire
              coeff: -1
              store: microbes.cyano.processes

            - name: sulfoxid
              coeff: -1
              store: microbes.csb.processes


    chlaEqn:
        var:
            name: chla
            store: microbes.cyano

        transient:
            coeff: 1

        sources:
            - name: chla_synth
              coeff: 1
              store: microbes.cyano.processes
